<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konwerter Unitechnik | Konstrukcje WM</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        :root {
            --primary: #1a5276;
            --primary-light: #2980b9;
            --accent: #27ae60;
            --accent-hover: #219a52;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #dce1e6;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 0.25rem;
        }

        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2 .icon {
            font-size: 1.3rem;
        }

        label {
            display: block;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.4rem;
            color: var(--text);
        }

        label .hint {
            font-weight: 400;
            color: var(--text-light);
            font-size: 0.8rem;
        }

        input[type="text"] {
            width: 100%;
            max-width: 300px;
            padding: 0.6rem 0.8rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
            font-family: 'Consolas', 'Courier New', monospace;
            text-transform: uppercase;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.12);
        }

        .form-row {
            margin-bottom: 1.25rem;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fafbfc;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary-light);
            background: #eef5fb;
        }

        .drop-zone .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

        .drop-zone p {
            font-size: 0.95rem;
            color: var(--text-light);
        }

        .drop-zone p strong {
            color: var(--primary-light);
            cursor: pointer;
        }

        .drop-zone .formats {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }

        .file-item .name {
            font-family: 'Consolas', monospace;
            font-weight: 500;
        }

        .file-item .size {
            color: var(--text-light);
            font-size: 0.78rem;
        }

        .file-item .remove {
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 0 0.3rem;
            border: none;
            background: none;
        }

        .actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.7rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
        }

        .btn-primary:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #bbb;
        }

        .log-area {
            background: #1e2730;
            color: #e0e6ed;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            max-height: 350px;
            overflow-y: auto;
            display: none;
        }

        .log-area.active { display: block; }

        .log-area .log-ok { color: #2ecc71; }
        .log-area .log-warn { color: #f1c40f; }
        .log-area .log-err { color: #e74c3c; }
        .log-area .log-info { color: #3498db; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-box .num {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.15rem;
        }

        .result-area {
            display: none;
        }

        .result-area.active { display: block; }

        .info-box {
            background: #eef5fb;
            border-left: 4px solid var(--primary-light);
            padding: 0.75rem 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .checkbox-row label {
            margin-bottom: 0;
            font-weight: 400;
            font-size: 0.88rem;
        }

        @media (max-width: 600px) {
            .container { padding: 0 1rem; }
            .card { padding: 1.25rem; }
            .header { padding: 1.25rem 1rem; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/images/WM_biale.png" alt="Konstrukcje WM" style="height: 36px; margin-bottom: 0.5rem;">
        <h1>üîß Konwerter Unitechnik</h1>
        <p>Konwersja plik√≥w .uni z Planbara do standardu Unitechnik CAD-CAM</p>
    </div>

    <div class="container">
        <!-- Settings -->
        <div class="card">
            <h2><span class="icon">‚öôÔ∏è</span> Ustawienia konwersji</h2>
            <div class="form-row">
                <label>Nazwa zam√≥wienia <span class="hint">(max 20 znak√≥w, np. NGOM, NSPN)</span></label>
                <input type="text" id="orderName" placeholder="np. NGOM" maxlength="20" autocomplete="off">
            </div>
            <div class="form-row">
                <label style="margin-bottom: 0.6rem;">Poprawki do zastosowania:</label>
                <div class="checkbox-row">
                    <input type="checkbox" id="fixHeader" checked>
                    <label for="fixHeader">Nag≈Ç√≥wek (HEADER) ‚Äî podmiana nazwy zam√≥wienia</label>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="fixSlabdate" checked>
                    <label for="fixSlabdate">SLABDATE ‚Äî uzupe≈Çnienie brakujƒÖcych zer</label>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="fixRodstock" checked>
                    <label for="fixRodstock">RODSTOCK ‚Äî konwersja giƒôcia prƒôt√≥w (format 001‚Üí002)</label>
                </div>
            </div>
        </div>

        <!-- File upload -->
        <div class="card">
            <h2><span class="icon">üìÅ</span> Pliki wej≈õciowe</h2>
            <div class="drop-zone" id="dropZone">
                <div class="icon">üìÑ</div>
                <p>PrzeciƒÖgnij pliki .uni tutaj lub <strong>kliknij aby wybraƒá</strong></p>
                <p class="formats">Akceptowane formaty: .uni, .zip (paczka plik√≥w .uni)</p>
            </div>
            <input type="file" id="fileInput" multiple accept=".uni,.zip" style="display:none">
            <div class="file-list" id="fileList"></div>
        </div>

        <!-- Convert button -->
        <div class="card">
            <div class="actions">
                <button class="btn btn-primary" id="convertBtn" disabled>
                    üîÑ Konwertuj pliki
                </button>
                <button class="btn btn-secondary" id="clearBtn" style="display:none">
                    üóëÔ∏è Wyczy≈õƒá
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="result-area" id="resultArea">
            <div class="card">
                <h2><span class="icon">‚úÖ</span> Wynik konwersji</h2>
                <div class="stats" id="stats"></div>
                <div style="margin-top: 1.25rem;">
                    <button class="btn btn-primary" id="downloadBtn">
                        ‚¨áÔ∏è Pobierz skonwertowane pliki (.zip)
                    </button>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="card">
            <h2><span class="icon">üìã</span> Log konwersji</h2>
            <div class="log-area active" id="logArea">
                <div class="log-info">Gotowy do pracy. Wgraj pliki .uni i kliknij "Konwertuj".</div>
            </div>
        </div>

        <!-- Info -->
        <div class="info-box">
            <strong>‚ÑπÔ∏è Informacja:</strong> Wszystkie pliki przetwarzane sƒÖ lokalnie w przeglƒÖdarce ‚Äî ≈ºadne dane nie sƒÖ wysy≈Çane na serwer.
            Konwerter poprawia pliki wyeksportowane z Planbara, dostosowujƒÖc je do wymaga≈Ñ standardu Unitechnik CAD-CAM v6.x.
        </div>
    </div>

    <script>
    // ============================================================
    //  Unitechnik .uni Converter ‚Äî Browser-side logic
    // ============================================================

    const state = {
        files: new Map(), // filename -> content (string)
        converted: new Map(), // filename -> converted content
        zipBlob: null
    };

    // ---------- DOM refs ----------
    const $dropZone   = document.getElementById('dropZone');
    const $fileInput   = document.getElementById('fileInput');
    const $fileList    = document.getElementById('fileList');
    const $convertBtn  = document.getElementById('convertBtn');
    const $clearBtn    = document.getElementById('clearBtn');
    const $resultArea  = document.getElementById('resultArea');
    const $stats       = document.getElementById('stats');
    const $downloadBtn = document.getElementById('downloadBtn');
    const $logArea     = document.getElementById('logArea');
    const $orderName   = document.getElementById('orderName');

    // ---------- Logging ----------
    function clearLog() { $logArea.innerHTML = ''; }
    function log(msg, cls = '') {
        const div = document.createElement('div');
        div.className = cls ? `log-${cls}` : '';
        div.textContent = msg;
        $logArea.appendChild(div);
        $logArea.scrollTop = $logArea.scrollHeight;
    }

    // ---------- File handling ----------
    $dropZone.addEventListener('click', () => $fileInput.click());
    $dropZone.addEventListener('dragover', e => { e.preventDefault(); $dropZone.classList.add('drag-over'); });
    $dropZone.addEventListener('dragleave', () => $dropZone.classList.remove('drag-over'));
    $dropZone.addEventListener('drop', e => {
        e.preventDefault();
        $dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    $fileInput.addEventListener('change', e => handleFiles(e.target.files));

    async function handleFiles(fileListObj) {
        for (const file of fileListObj) {
            if (file.name.toLowerCase().endsWith('.zip')) {
                await handleZip(file);
            } else if (file.name.toLowerCase().endsWith('.uni')) {
                const text = await file.text();
                state.files.set(file.name, text);
                log(`Dodano: ${file.name} (${formatSize(file.size)})`, 'info');
            } else {
                log(`Pominiƒôto: ${file.name} (nieobs≈Çugiwany format)`, 'warn');
            }
        }
        renderFileList();
        updateButtons();
    }

    async function handleZip(file) {
        try {
            const zip = await JSZip.loadAsync(file);
            let count = 0;
            for (const [path, entry] of Object.entries(zip.files)) {
                if (!entry.dir && path.toLowerCase().endsWith('.uni')) {
                    const name = path.split('/').pop();
                    const text = await entry.async('string');
                    state.files.set(name, text);
                    count++;
                }
            }
            log(`Rozpakowano: ${file.name} ‚Üí ${count} plik√≥w .uni`, 'info');
        } catch (e) {
            log(`B≈ÇƒÖd odczytu ZIP: ${e.message}`, 'err');
        }
    }

    function renderFileList() {
        $fileList.innerHTML = '';
        for (const [name, content] of state.files) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span class="name">${name}</span>
                <span class="size">${formatSize(content.length)}</span>
                <button class="remove" data-name="${name}" title="Usu≈Ñ">‚úï</button>
            `;
            $fileList.appendChild(div);
        }
        $fileList.querySelectorAll('.remove').forEach(btn => {
            btn.addEventListener('click', () => {
                state.files.delete(btn.dataset.name);
                renderFileList();
                updateButtons();
            });
        });
    }

    function updateButtons() {
        const hasFiles = state.files.size > 0;
        $convertBtn.disabled = !hasFiles;
        $clearBtn.style.display = hasFiles ? '' : 'none';
    }

    $clearBtn.addEventListener('click', () => {
        state.files.clear();
        state.converted.clear();
        state.zipBlob = null;
        $resultArea.classList.remove('active');
        renderFileList();
        updateButtons();
        clearLog();
        log('Wyczyszczono.', 'info');
    });

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        return (bytes / 1024).toFixed(1) + ' KB';
    }

    // ============================================================
    //  CONVERTER CORE
    // ============================================================

    /**
     * Compute transition length for a bent bar in polyline format.
     * Based on empirical data from known Planbar‚ÜîUnitechnik file pairs:
     *   offset=40 ‚Üí transition=93 (consistent across different bar diameters and mandrels)
     */
    function computeTransitionLength(offset) {
        if (offset <= 0) return 0;
        // Known mapping: 40‚Üí93. Use linear ratio as approximation.
        return Math.round(offset * 93.0 / 40.0);
    }

    /**
     * Parse format 001 bend line into two bend descriptions.
     * Format: "004 00200 00000 00000 00060 040 004 00100 00000 00000 00060 040 +000"
     */
    function parseBendLine001(line) {
        const p = line.trim().split(/\s+/);
        if (p.length < 13) return null;
        return {
            bend1: {
                type: parseInt(p[0]),
                length: parseInt(p[1]),
                p2: parseInt(p[2]),
                p3: parseInt(p[3]),
                param: parseInt(p[4]),
                offset: parseInt(p[5])
            },
            bend2: {
                type: parseInt(p[6]),
                length: parseInt(p[7]),
                p2: parseInt(p[8]),
                p3: parseInt(p[9]),
                param: parseInt(p[10]),
                offset: parseInt(p[11])
            },
            direction: p[12]
        };
    }

    /**
     * Format a number with sign and zero-padding: e.g., -202 ‚Üí "-00202", 50 ‚Üí "+00050"
     */
    function signedNum(val, width = 5) {
        const sign = val >= 0 ? '+' : '-';
        return sign + String(Math.abs(val)).padStart(width, '0');
    }

    /**
     * Convert a single .uni file content.
     */
    function convertUniFile(content, orderName, options = {}) {
        const fixHeader = options.fixHeader !== false;
        const fixSlabdate = options.fixSlabdate !== false;
        const fixRodstock = options.fixRodstock !== false;

        // Normalize line endings ‚Äî keep \r\n (standard for Unitechnik)
        const rawLines = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        const lines = rawLines; // work on array

        const stats = { headerFixed: false, slabdateFixed: false, rodsConverted: 0 };

        // --- First pass: extract element number from SLABDATE ---
        let elementNum = '';
        let storey = '';
        for (let i = 0; i < lines.length; i++) {
            const s = lines[i].trim();
            if (s === 'SLABDATE') {
                for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
                    const t = lines[j].trim();
                    if (t && t !== '610') {
                        elementNum = t.split(/\s+/)[0];
                        break;
                    }
                }
                break;
            }
        }

        // Extract storey from raw header if present (e.g., "GARA" at positions 27-31)
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === 'HEADER__') {
                if (i + 2 < lines.length) {
                    const hdr = lines[i + 2];
                    // Storey is typically at a fixed position or can be extracted
                    // from the raw line. In raw Planbar files, storey appears
                    // after the generic name in the middle of the line.
                    const padded = hdr.padEnd(46);
                    storey = padded.substring(27, 31).trim();
                }
                break;
            }
        }

        // --- Second pass: transform ---
        const result = [];
        let section = '';
        let lineInSection = 0;
        let headerVersionSeen = false;
        let slabdateDataLine = 0;
        let i = 0;

        while (i < lines.length) {
            const s = lines[i].trim();

            // Track section starts
            if (s === 'HEADER__') { section = 'HEADER'; headerVersionSeen = false; lineInSection = 0; }
            else if (s === 'SLABDATE') { section = 'SLABDATE'; slabdateDataLine = 0; }
            else if (s === 'RODSTOCK') { section = 'RODSTOCK'; }
            else if (s === 'CONTOUR_' || s === 'CUTOUT__' || s === 'MOUNPART' || s === 'BRGIRDER') {
                section = s;
            } else if (s.startsWith('END')) {
                // Keep section for END line, reset after
            }

            // --- HEADER fix ---
            if (fixHeader && section === 'HEADER') {
                if (s === '610' && !headerVersionSeen) {
                    headerVersionSeen = true;
                    result.push(lines[i]);
                    i++;

                    // Next line is header line 3 ‚Äî replace it
                    if (i < lines.length) {
                        const order = (orderName || '').toUpperCase().padEnd(20).substring(0, 20);
                        const comp = (elementNum || '').padEnd(5).substring(0, 5);
                        const stor = (storey || '').padEnd(4).substring(0, 4);
                        const draw = (elementNum || '').padEnd(8).substring(0, 8);
                        const newLine3 = `${order} ${comp} ${stor} ${draw} 00   `;
                        result.push(newLine3);
                        stats.headerFixed = true;
                        i++; // skip original line 3
                        
                        // Skip 3 empty/spacing lines
                        for (let skip = 0; skip < 3 && i < lines.length; skip++) {
                            result.push(lines[i]);
                            i++;
                        }
                        
                        // Line 7: repeat of order name ‚Äî replace
                        if (i < lines.length) {
                            const orig7 = lines[i];
                            // Check if this line is the name repeat (usually starts with "strop" or similar)
                            const trimmed7 = orig7.trim();
                            if (trimmed7 && !trimmed7.startsWith('END') && !trimmed7.match(/^\d/)) {
                                const newLine7 = order;
                                result.push(newLine7);
                                i++;
                            }
                        }
                        continue;
                    }
                }
            }

            // --- SLABDATE fix ---
            if (fixSlabdate && section === 'SLABDATE') {
                if (s && s !== 'SLABDATE' && s !== '610' && s !== 'END') {
                    slabdateDataLine++;
                    // Line 2 of SLABDATE data has the zero-padding issue
                    if (slabdateDataLine === 2) {
                        // Pattern: "11.760 000 00          0.000" ‚Üí fill empty space with 00000000
                        const fixed = lines[i].replace(
                            /(\d+\.\d+ \d{3} \d{2})\s{10}(\d+\.\d+)/,
                            '$1 00000000 $2'
                        );
                        if (fixed !== lines[i]) {
                            result.push(fixed);
                            stats.slabdateFixed = true;
                            i++;
                            continue;
                        }
                    }
                }
            }

            // --- RODSTOCK fix ---
            if (fixRodstock && section === 'RODSTOCK') {
                // Detect type 2 rod (bent bar) with format 001
                const parts = s.split(/\s+/);
                if (parts.length >= 10 && parts[2] === '2' && /^\d{3}$/.test(parts[0])) {
                    // This is a bent bar line. Check next lines for format 001
                    const line2Idx = i + 1;
                    const line3Idx = i + 2;
                    if (line2Idx < lines.length && line3Idx < lines.length) {
                        const line2Parts = lines[line2Idx].trim().split(/\s+/);
                        if (line2Parts.length >= 7 && line2Parts[6] === '001') {
                            // Parse rod data
                            const mandrel = parseInt(line2Parts[1]);
                            const diameter = parseInt(parts[5]);
                            const totalLength = parseInt(parts[6]);
                            const yPos = parseInt(parts[7]);
                            const bendValue = parseInt(line2Parts[5]);
                            
                            // Parse bend line
                            const bends = parseBendLine001(lines[line3Idx]);
                            if (bends) {
                                const b1 = bends.bend1;
                                const b2 = bends.bend2;
                                const has1 = b1.offset > 0;
                                const has2 = b2.offset > 0;
                                
                                const t1 = has1 ? computeTransitionLength(b1.offset) : 0;
                                const t2 = has2 ? computeTransitionLength(b2.offset) : 0;
                                const l1 = has1 ? b1.length : 0;
                                const l2 = has2 ? b2.length : 0;
                                const o1 = has1 ? b1.offset : 0;
                                const o2 = has2 ? b2.offset : 0;
                                
                                // Y-position adjustment
                                const yAdj = Math.floor(Math.max(o1, o2) / 2);
                                const newY = yPos + yAdj;
                                
                                // Rebuild rod line 1 with adjusted Y ‚Äî preserve original formatting
                                const newLine1 = lines[i].replace(
                                    /(^\d{3} \d{3} 2 \S+\s+\d{5} \d{3} \d{5} )[+-]\d{5}/,
                                    '$1' + signedNum(newY)
                                );
                                result.push(newLine1);
                                
                                // Rod line 2: update bend value and format
                                const newBendVal = String(bendValue + (has1 ? b1.param : (has2 ? b2.param : 0))).padStart(5, '0');
                                const newLine2Parts = [...line2Parts];
                                newLine2Parts[5] = newBendVal;
                                newLine2Parts[6] = '002';
                                result.push(newLine2Parts.join(' '));
                                
                                // Polyline header
                                result.push('000 01');
                                
                                // Build polyline
                                let polyline;
                                if (has1 && has2) {
                                    const middle = totalLength - l1 - l2 - t1 - t2;
                                    polyline = `01 05 ` +
                                        `${String(l1).padStart(5,'0')} ${signedNum(-o1, 3)} ` +
                                        `${String(t1).padStart(5,'0')} ${signedNum(o1, 3)} ` +
                                        `${String(middle).padStart(5,'0')} ${signedNum(o2, 3)} ` +
                                        `${String(t2).padStart(5,'0')} ${signedNum(-o2, 3)} ` +
                                        `${String(l2).padStart(5,'0')} +000`;
                                } else if (has2) {
                                    // Bend only at end
                                    const middle = totalLength - l2 - t2;
                                    polyline = `01 03 ` +
                                        `${String(middle).padStart(5,'0')} ${signedNum(o2, 3)} ` +
                                        `${String(t2).padStart(5,'0')} ${signedNum(-o2, 3)} ` +
                                        `${String(l2).padStart(5,'0')} +000`;
                                } else if (has1) {
                                    // Bend only at start
                                    const middle = totalLength - l1 - t1;
                                    polyline = `01 03 ` +
                                        `${String(l1).padStart(5,'0')} ${signedNum(-o1, 3)} ` +
                                        `${String(t1).padStart(5,'0')} ${signedNum(o1, 3)} ` +
                                        `${String(middle).padStart(5,'0')} +000`;
                                }
                                
                                result.push(polyline);
                                stats.rodsConverted++;
                                i += 3; // skip original 3 lines
                                continue;
                            }
                        }
                    }
                }
            }

            // Default: pass through
            result.push(lines[i]);
            i++;
        }

        // Rejoin with \r\n (Unitechnik standard)
        const output = result.join('\r\n');
        return { content: output, stats };
    }

    // ============================================================
    //  CONVERT & DOWNLOAD
    // ============================================================

    $convertBtn.addEventListener('click', async () => {
        clearLog();
        const orderName = $orderName.value.trim();
        
        if (!orderName) {
            log('‚ö†Ô∏è  Podaj nazwƒô zam√≥wienia!', 'warn');
            $orderName.focus();
            return;
        }

        const options = {
            fixHeader: document.getElementById('fixHeader').checked,
            fixSlabdate: document.getElementById('fixSlabdate').checked,
            fixRodstock: document.getElementById('fixRodstock').checked
        };

        log(`Rozpoczynam konwersjƒô ${state.files.size} plik√≥w...`, 'info');
        log(`Zam√≥wienie: ${orderName.toUpperCase()}`, 'info');
        log(`Poprawki: Nag≈Ç√≥wek=${options.fixHeader ? 'TAK' : 'NIE'}, SLABDATE=${options.fixSlabdate ? 'TAK' : 'NIE'}, RODSTOCK=${options.fixRodstock ? 'TAK' : 'NIE'}`, 'info');
        log('‚îÄ'.repeat(60));

        state.converted.clear();
        let totalHeaders = 0, totalSlabdate = 0, totalRods = 0, errors = 0;

        for (const [filename, content] of state.files) {
            try {
                const { content: converted, stats } = convertUniFile(content, orderName, options);
                state.converted.set(filename, converted);

                const changes = [];
                if (stats.headerFixed) { changes.push('HEADER'); totalHeaders++; }
                if (stats.slabdateFixed) { changes.push('SLABDATE'); totalSlabdate++; }
                if (stats.rodsConverted > 0) { changes.push(`RODSTOCK(${stats.rodsConverted})`); totalRods += stats.rodsConverted; }

                if (changes.length > 0) {
                    log(`‚úÖ ${filename} ‚Üí ${changes.join(', ')}`, 'ok');
                } else {
                    log(`‚ö™ ${filename} ‚Üí brak zmian`, '');
                }
            } catch (e) {
                log(`‚ùå ${filename} ‚Üí B≈ÅƒÑD: ${e.message}`, 'err');
                errors++;
            }
        }

        log('‚îÄ'.repeat(60));
        log(`Zako≈Ñczono: ${state.converted.size} plik√≥w przetworzonych, ${errors} b≈Çƒôd√≥w.`, errors ? 'warn' : 'ok');

        // Build ZIP
        const zip = new JSZip();
        for (const [name, content] of state.converted) {
            zip.file(name, content);
        }
        state.zipBlob = await zip.generateAsync({ type: 'blob' });

        // Show stats
        $stats.innerHTML = `
            <div class="stat-box"><div class="num">${state.converted.size}</div><div class="label">plik√≥w</div></div>
            <div class="stat-box"><div class="num">${totalHeaders}</div><div class="label">nag≈Ç√≥wk√≥w</div></div>
            <div class="stat-box"><div class="num">${totalSlabdate}</div><div class="label">SLABDATE</div></div>
            <div class="stat-box"><div class="num">${totalRods}</div><div class="label">prƒôt√≥w giƒôtych</div></div>
        `;
        $resultArea.classList.add('active');
    });

    $downloadBtn.addEventListener('click', () => {
        if (!state.zipBlob) return;
        const orderName = $orderName.value.trim().toUpperCase() || 'converted';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(state.zipBlob);
        a.download = `${orderName}_unitechnik.zip`;
        a.click();
        URL.revokeObjectURL(a.href);
        log(`‚¨áÔ∏è Pobrano: ${orderName}_unitechnik.zip`, 'ok');
    });

    </script>
</body>
</html>
